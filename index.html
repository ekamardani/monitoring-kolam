<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Suhu & Kelembapan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        canvas { max-width: 300px; margin: auto; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .message-box, .control-box { margin-top: 20px; padding: 10px; border: 1px solid #ddd; }
        .slider { width: 80%; }
    </style>
</head>
<body>
    <h2>Monitoring Suhu & Kelembapan</h2>
    <div class="container">
        <canvas id="tempChart"></canvas>
        <canvas id="humidChart"></canvas>
        
        <div class="control-box">
            <h3>Atur Batas Notifikasi</h3>
            <p>Suhu: <span id="tempLower">20</span>°C - <span id="tempUpper">35</span>°C</p>
            <input type="range" min="0" max="50" value="20" class="slider" id="tempLowerSlider">
            <input type="range" min="0" max="50" value="35" class="slider" id="tempUpperSlider">
            
            <p>Kelembapan: <span id="humidLower">40</span>% - <span id="humidUpper">80</span>%</p>
            <input type="range" min="0" max="100" value="40" class="slider" id="humidLowerSlider">
            <input type="range" min="0" max="100" value="80" class="slider" id="humidUpperSlider">
            
            <button onclick="saveSettings()">Simpan Batas</button>
            <button onclick="toggleNotification()" id="notifButton">Aktifkan Notifikasi</button>
        </div>
        
        <div class="message-box">
            <h3>Pesan Telegram:</h3>
            <p id="latestMessage">Menunggu pesan...</p>
        </div>
    </div>
    
    <script>
        const tempCtx = document.getElementById('tempChart').getContext('2d');
        const humidCtx = document.getElementById('humidChart').getContext('2d');
        const googleScriptURL = "YOUR_GOOGLE_SCRIPT_URL?action=getLatest";
        const googlePostURL = "YOUR_GOOGLE_SCRIPT_URL";
        const telegramAPI = "https://api.telegram.org/botYOUR_BOT_TOKEN/getUpdates";
        let notifActive = false;
        
        const tempChart = new Chart(tempCtx, {
            type: 'doughnut',
            data: { labels: ['Suhu', 'Max'], datasets: [{ data: [0, 100], backgroundColor: ['red', 'lightgray'] }] },
            options: { responsive: true, cutout: '80%' }
        });
        
        const humidChart = new Chart(humidCtx, {
            type: 'doughnut',
            data: { labels: ['Kelembapan', 'Max'], datasets: [{ data: [0, 100], backgroundColor: ['blue', 'lightgray'] }] },
            options: { responsive: true, cutout: '80%' }
        });
        
        function fetchData() {
            fetch(googleScriptURL)
                .then(response => response.json())
                .then(data => {
                    let suhu = parseFloat(data.temperature);
                    let humidity = parseFloat(data.humidity);
                    tempChart.data.datasets[0].data = [suhu, 100 - suhu];
                    humidChart.data.datasets[0].data = [humidity, 100 - humidity];
                    tempChart.update();
                    humidChart.update();
                });
        }
        
        function getTelegramMessages() {
            fetch(telegramAPI)
                .then(response => response.json())
                .then(data => {
                    let messages = data.result;
                    if (messages.length > 0) {
                        document.getElementById('latestMessage').innerText = messages[messages.length - 1].message.text;
                    }
                });
        }
        
        function saveSettings() {
            let tempLower = document.getElementById('tempLowerSlider').value;
            let tempUpper = document.getElementById('tempUpperSlider').value;
            let humidLower = document.getElementById('humidLowerSlider').value;
            let humidUpper = document.getElementById('humidUpperSlider').value;
            
            document.getElementById('tempLower').innerText = tempLower;
            document.getElementById('tempUpper').innerText = tempUpper;
            document.getElementById('humidLower').innerText = humidLower;
            document.getElementById('humidUpper').innerText = humidUpper;
            
            fetch(googlePostURL + `?action=setThreshold&tempLower=${tempLower}&tempUpper=${tempUpper}&humidLower=${humidLower}&humidUpper=${humidUpper}`, {
                method: 'POST'
            });
        }
        
        function toggleNotification() {
            notifActive = !notifActive;
            document.getElementById('notifButton').innerText = notifActive ? 'Nonaktifkan Notifikasi' : 'Aktifkan Notifikasi';
            
            fetch(googlePostURL + `?action=toggleNotif&status=${notifActive ? 'on' : 'off'}`, {
                method: 'POST'
            });
        }
        
        setInterval(fetchData, 5000);
        setInterval(getTelegramMessages, 5000);
    </script>
</body>
</html>
