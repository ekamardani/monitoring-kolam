<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gauge.js/1.3.7/gauge.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <h1>Temperature Monitor</h1>
        <div id="temperature">Loading...</div>
        <canvas id="gaugeCanvas"></canvas>
        
        <h2>Set Temperature Threshold</h2>
        <label>High Temperature: <span id="high-temp-value">30</span>째C</label>
        <input type="range" min="0" max="50" value="30" id="high-temp-slider">
        <label>Low Temperature: <span id="low-temp-value">20</span>째C</label>
        <input type="range" min="0" max="50" value="20" id="low-temp-slider">
        <button id="save-settings">Save Settings</button>
        
        <h2>Generate Report</h2>
        <button id="daily-report">Daily Report</button>
        <button id="weekly-report">Weekly Report</button>
        <button id="monthly-report">Monthly Report</button>
    </div>
    
    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwuZQJJKxjZTrc9eLhQEacTagCJsVELs27KvoA9Nvgcxjf36ytwFFzQGiugl6hRQp0/exec';
        const telegramWebApp = window.Telegram.WebApp;
        telegramWebApp.expand();
        telegramWebApp.ready();
        
        async function fetchTemperature() {
            try {
                let response = await fetch(GOOGLE_SCRIPT_URL + "?action=getLatestTemperature");
                let data = await response.json();
                document.getElementById("temperature").innerText = `Current: ${data.temperature}째C`;
            } catch (error) {
                console.error("Error fetching temperature", error);
            }
        }
        
        async function saveSettings() {
            let highTemp = document.getElementById("high-temp-slider").value;
            let lowTemp = document.getElementById("low-temp-slider").value;
            
            await fetch(GOOGLE_SCRIPT_URL + "?action=updateSettings&highTemp=" + highTemp + "&lowTemp=" + lowTemp, { method: 'POST' });
            alert("Settings saved");
        }
        
        async function generateReport(type) {
            let response = await fetch(GOOGLE_SCRIPT_URL + "?action=generateReport&reportType=" + type);
            let data = await response.json();
            const { jsPDF } = window.jspdf;
            let doc = new jsPDF();
            doc.text(`Temperature Report: ${type.toUpperCase()}`, 10, 10);
            doc.text(`Average: ${data.statistics.average}째C`, 10, 20);
            doc.save(`${type}-report.pdf`);
        }
        
        document.getElementById("save-settings").addEventListener("click", saveSettings);
        document.getElementById("daily-report").addEventListener("click", () => generateReport("daily"));
        document.getElementById("weekly-report").addEventListener("click", () => generateReport("weekly"));
        document.getElementById("monthly-report").addEventListener("click", () => generateReport("monthly"));
        
        fetchTemperature();
        setInterval(fetchTemperature, 5000);
    </script>
</body>
</html>
